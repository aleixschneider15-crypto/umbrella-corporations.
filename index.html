<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Umbrella Corporations — Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f8;
      color: #333;
    }
    .sidebar {
      position: fixed;
      top: 0; left: 0;
      width: 220px;
      height: 100%;
      background-color: #1f2937;
      color: #fff;
      padding: 20px;
    }
    .sidebar h2 {
      font-size: 1.2rem;
      margin-bottom: 20px;
    }
    .sidebar button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #374151;
      border: none;
      color: #fff;
      cursor: pointer;
      border-radius: 6px;
    }
    .sidebar button:hover {
      background: #4b5563;
    }
    .main {
      margin-left: 240px;
      padding: 20px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    h3 {
      margin-top: 0;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button.submit {
      margin-top: 12px;
      padding: 10px 16px;
      background: #2563eb;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.submit:hover {
      background: #1d4ed8;
    }
    .hidden {
      display: none;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .topbar h1 {
      font-size: 1.5rem;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Umbrella Corp</h2>
    <button onclick="mostrar('correo')">Correo</button>
    <button onclick="mostrar('medico')">Médico</button>
    <button onclick="mostrar('stars')">S.T.A.R.S.</button>
    <button onclick="mostrar('archivos')">Archivos</button>
    <button onclick="logout()">Cerrar sesión</button>
  </div>
  <div class="main">
    <div class="topbar">
      <h1>Panel Administrativo</h1>
      <p id="usuario"></p>
    </div>
    <!-- Sección Correo -->
    <section id="correo" class="card hidden">
      <h3>Correo Corporativo</h3>
      <div id="correoLista">
        <p><strong>De:</strong> seguridad@umbrella.com</p>
        <p><strong>Asunto:</strong> Informe de laboratorio</p>
        <p>Se ha detectado actividad no autorizada en el laboratorio 3B.</p>
      </div>
    </section>

    <!-- Sección Médico -->
    <section id="medico" class="card hidden">
      <h3>Portal Médico</h3>
      <form id="formPaciente">
        <label>ID del paciente</label>
        <input type="text" id="pacienteId" required />
        <label>Nombre</label>
        <input type="text" id="pacienteNombre" required />
        <label>Diagnóstico</label>
        <input type="text" id="pacienteDiagnostico" required />
        <label>Estado</label>
        <input type="text" id="pacienteEstado" required />
        <button type="submit" class="submit">Guardar ficha</button>
      </form>
      <form id="buscarPorIdForm">
        <label>Buscar paciente por ID</label>
        <input type="text" id="buscarId" required />
        <button type="submit" class="submit">Buscar</button>
      </form>
      <div id="resultadoId"></div>
    </section>

    <!-- Sección S.T.A.R.S. -->
    <section id="stars" class="card hidden">
      <h3>Panel S.T.A.R.S.</h3>
      <form id="formMision">
        <label>Agente</label>
        <input type="text" id="agente" required />
        <label>Rango</label>
        <input type="text" id="rango" required />
        <label>Estado</label>
        <input type="text" id="estado" required />
        <label>Misión</label>
        <textarea id="mision" required></textarea>
        <button type="submit" class="submit">Registrar misión</button>
      </form>
      <form id="buscarAgenteForm">
        <label>Buscar misiones por agente</label>
        <input type="text" id="buscarAgente" required />
        <button type="submit" class="submit">Buscar</button>
      </form>
      <div id="resultadoMisiones"></div>
    </section>

    <!-- Sección Archivos -->
    <section id="archivos" class="card hidden">
      <h3>Subida de Archivos</h3>
      <form id="uploadForm">
        <label>Selecciona un archivo</label>
        <input type="file" id="fileInput" />
        <button type="submit" class="submit">Subir</button>
      </form>
      <div id="uploadStatus"></div>
    </section>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    setDoc,
    doc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_DOMINIO.firebaseapp.com",
    projectId: "TU_ID_PROYECTO",
    storageBucket: "TU_BUCKET.appspot.com",
    messagingSenderId: "TU_SENDER_ID",
    appId: "TU_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const usuario = document.getElementById("usuario");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      usuario.textContent = user.email;
      const token = await user.getIdTokenResult();
      const rol = token.claims.rol;
      if (rol === "medico") mostrar("medico");
      else if (rol === "agente") mostrar("stars");
      else mostrar("correo");
    } else {
      window.location.href = "/login.html";
    }
  });

  window.mostrar = function(id) {
    ["correo", "medico", "stars", "archivos"].forEach(sec => {
      document.getElementById(sec).classList.add("hidden");
    });
    document.getElementById(id).classList.remove("hidden");
  };

  window.logout = async function() {
    await signOut(auth);
    window.location.href = "/login.html";
  };

  // Médico
  document.getElementById("formPaciente").addEventListener("submit", async (e) => {
    e.preventDefault();
    const ficha = {
      id: pacienteId.value,
      nombre: pacienteNombre.value,
      diagnostico: pacienteDiagnostico.value,
      estado: pacienteEstado.value
    };
    await addDoc(collection(db, "pacientes"), ficha);
    alert("Ficha guardada");
  });

  document.getElementById("buscarPorIdForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const q = query(collection(db, "pacientes"), where("id", "==", buscarId.value));
    const resultados = await getDocs(q);
    resultadoId.innerHTML = "";
    resultados.forEach(doc => {
      const data = doc.data();
      resultadoId.innerHTML += `
        <div>
          <h4>${data.nombre}</h4>
          <p>Diagnóstico: ${data.diagnostico}</p>
          <p>Estado: ${data.estado}</p>
          <button onclick="editarPaciente('${doc.id}')">Editar</button>
          <button onclick="eliminarPaciente('${doc.id}')">Eliminar</button>
        </div>
      `;
    });
  });

  window.editarPaciente = async function(docId) {
    const nuevoNombre = prompt("Nuevo nombre:");
    const nuevoDiagnostico = prompt("Nuevo diagnóstico:");
    const nuevoEstado = prompt("Nuevo estado:");
    if (nuevoNombre && nuevoDiagnostico && nuevoEstado) {
      await setDoc(doc(db, "pacientes", docId), {
        nombre: nuevoNombre,
        diagnostico: nuevoDiagnostico,
        estado: nuevoEstado
      }, { merge: true });
      alert("Ficha actualizada");
    }
  };

  window.eliminarPaciente = async function(docId) {
    if (confirm("¿Eliminar esta ficha?")) {
      await deleteDoc(doc(db, "pacientes", docId));
      alert("Ficha eliminada");
    }
  };

  // S.T.A.R.S.
  document.getElementById("formMision").addEventListener("submit", async (e) => {
    e.preventDefault();
    const mision = {
      agente: agente.value,
      rango: rango.value,
      estado: estado.value,
      mision: mision.value
    };
    await addDoc(collection(db, "misiones"), mision);
    alert("Misión registrada");
  });

  document.getElementById("buscarAgenteForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const q = query(collection(db, "misiones"), where("agente", "==", buscarAgente.value));
    const resultados = await getDocs(q);
    resultadoMisiones.innerHTML = "";
    resultados.forEach(doc => {
      const data = doc.data();
      resultadoMisiones.innerHTML += `
        <div>
          <h4>${data.agente}</h4>
          <p>Rango: ${data.rango}</p>
          <p>Estado: ${data.estado}</p>
          <p>Misión: ${data.mision}</p>
        </div>
      `;
    });
  });

  // Archivos
  document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = fileInput.files[0];
    if (!file) return;
    const storageRef = ref(storage, "archivos/" + file.name);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    uploadStatus.textContent = "Archivo subido: " + url;
  });
</script>
</body>
</html>
