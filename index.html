<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    where,
    setDoc,
    doc,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDCliOcd9eQky_HrT4EPciJQFPN5h7L3vw",
    authDomain: "umbrella-web.firebaseapp.com",
    projectId: "umbrella-web",
    storageBucket: "umbrella-web.appspot.com",
    messagingSenderId: "852354344645",
    appId: "1:852354344645:web:8280c7a88ae5d2973af2ac",
    measurementId: "G-LL39DJFBMQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const msg = document.getElementById("mensaje");

  const logoutBtn = document.getElementById("logoutBtn");
  const logoutBtn2 = document.getElementById("logoutBtn2");
  const logoutBtn3 = document.getElementById("logoutBtn3");
  const logoutBtn4 = document.getElementById("logoutBtn4");

  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    msg.textContent = "Procesando…";
    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      msg.textContent = "✅ Bienvenido " + cred.user.email;
    } catch (err) {
      msg.textContent = "❌ " + err.message;
    }
  });

  logoutBtn.onclick = logoutBtn2.onclick = logoutBtn3.onclick = logoutBtn4.onclick = async () => {
    await signOut(auth);
    msg.textContent = "Has cerrado sesión.";
    mostrarSeccion("loginSection");
  };

  onAuthStateChanged(auth, async (user) => {
    const conectado = !!user;
    document.getElementById("loginSection").classList.toggle("sr-only", conectado);
    document.getElementById("contenido-protegido").classList.toggle("sr-only", !conectado);
    ["correo", "medico", "stars", "archivos"].forEach(id => {
      document.getElementById(id).classList.add("sr-only");
    });

    if (user) {
      const token = await user.getIdTokenResult();
      const rol = token.claims.rol;
      if (rol === "medico") mostrarSeccion("medico");
      else if (rol === "agente") mostrarSeccion("stars");
      else if (rol === "admin") mostrarSeccion("contenido-protegido");
    }
  });

  window.mostrarSeccion = function(id) {
    ["contenido-protegido", "correo", "medico", "stars", "archivos", "loginSection"].forEach(sec => {
      document.getElementById(sec).classList.add("sr-only");
    });
    document.getElementById(id).classList.remove("sr-only");
  };

  // Portal Médico
  document.getElementById("formPaciente").addEventListener("submit", async (e) => {
    e.preventDefault();
    const ficha = {
      id: document.getElementById("pacienteId").value,
      nombre: document.getElementById("pacienteNombre").value,
      diagnostico: document.getElementById("pacienteDiagnostico").value,
      estado: document.getElementById("pacienteEstado").value
    };
    await addDoc(collection(db, "pacientes"), ficha);
    alert("Ficha guardada");
  });

  document.getElementById("buscarPorIdForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const idBuscado = document.getElementById("buscarId").value;
    const q = query(collection(db, "pacientes"), where("id", "==", idBuscado));
    const resultados = await getDocs(q);
    const contenedor = document.getElementById("resultadoId");
    contenedor.innerHTML = "";
    resultados.forEach(doc => {
      const data = doc.data();
      contenedor.innerHTML += `
        <div>
          <h4>${data.nombre}</h4>
          <p>Diagnóstico: ${data.diagnostico}</p>
          <p>Estado: ${data.estado}</p>
          <button onclick="editarPaciente('${doc.id}')">Editar</button>
          <button onclick="eliminarPaciente('${doc.id}')">Eliminar</button>
        </div>
      `;
    });
  });

  window.editarPaciente = async function(docId) {
    const nuevoNombre = prompt("Nuevo nombre:");
    const nuevoDiagnostico = prompt("Nuevo diagnóstico:");
    const nuevoEstado = prompt("Nuevo estado:");
    if (nuevoNombre && nuevoDiagnostico && nuevoEstado) {
      await setDoc(doc(db, "pacientes", docId), {
        nombre: nuevoNombre,
        diagnostico: nuevoDiagnostico,
        estado: nuevoEstado
      }, { merge: true });
      alert("Ficha actualizada");
    }
  };

  window.eliminarPaciente = async function(docId) {
    if (confirm("¿Eliminar esta ficha?")) {
      await deleteDoc(doc(db, "pacientes", docId));
      alert("Ficha eliminada");
    }
  };

  // Panel S.T.A.R.S.
  document.getElementById("formMision").addEventListener("submit", async (e) => {
    e.preventDefault();
    const mision = {
      agente: document.getElementById("agente").value,
      rango: document.getElementById("rango").value,
      estado: document.getElementById("estado").value,
      mision: document.getElementById("mision").value
    };
    await addDoc(collection(db, "misiones"), mision);
    alert("Misión registrada");
  });

  document.getElementById("buscarAgenteForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const agente = document.getElementById("buscarAgente").value;
    const q = query(collection(db, "misiones"), where("agente", "==", agente));
    const resultados = await getDocs(q);
    const contenedor = document.getElementById("resultadoMisiones");
    contenedor.innerHTML = "";
    resultados.forEach(doc => {
      const data = doc.data();
      contenedor.innerHTML += `
        <div>
          <h4>${data.agente}</h4>
          <p>Rango: ${data.rango}</p>
          <p>Estado: ${data.estado}</p>
          <p>Misión: ${data.mision}</p>
        </div>
      `;
    });
  });

  // Subida de archivos
  document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = document.getElementById("fileInput").files[0];
    if (!file) return;
    const storageRef = ref(storage, "archivos/" + file.name);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    document.getElementById("uploadStatus").textContent = "Archivo subido: " + url;
  });
</script>
</body>
</html>
